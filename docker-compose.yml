# ============================================
# Security Nexus - Docker Compose Configuration
# ============================================
# Make sure to:
# 1. Copy .env.example to .env
# 2. Update .env with your configuration
# 3. Run: docker-compose up -d

version: '3.8'

services:
  # ============================================
  # Monitoring Engine (Rust Backend)
  # ============================================
  monitoring-engine:
    build:
      context: .
      dockerfile: ./packages/monitoring-engine/Dockerfile
      # Use BuildKit for better caching
      cache_from:
        - monitoring-engine:latest
    image: ${COMPOSE_PROJECT_NAME:-security-nexus}/monitoring-engine:latest
    container_name: ${COMPOSE_PROJECT_NAME:-security-nexus}-monitoring-engine
    environment:
      - WS_ENDPOINT=${WS_ENDPOINT:-wss://polkadot.api.onfinality.io/public-ws}
      - CHAIN_NAME=${CHAIN_NAME:-Polkadot}
      - API_PORT=${API_PORT:-8080}
      - RUST_LOG=${RUST_LOG:-monitoring_engine=info}
      - ALLOWED_ORIGIN=${ALLOWED_ORIGIN:-http://localhost:3000}
    ports:
      - "${API_PORT:-8080}:8080"
    restart: unless-stopped
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  # ============================================
  # Web Dashboard (Next.js Frontend + SAFT)
  # ============================================
  dashboard:
    build:
      context: .
      dockerfile: ./packages/web-dashboard/Dockerfile
      cache_from:
        - dashboard:latest
    image: ${COMPOSE_PROJECT_NAME:-security-nexus}/dashboard:latest
    container_name: ${COMPOSE_PROJECT_NAME:-security-nexus}-dashboard
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - MONITORING_ENGINE_URL=${MONITORING_ENGINE_URL:-http://monitoring-engine:8080}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:3000}
      - SAFT_BINARY_PATH=/usr/local/bin/saft
    ports:
      - "3000:3000"
    depends_on:
      monitoring-engine:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 60s

  # ============================================
  # Nginx Reverse Proxy
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: ${COMPOSE_PROJECT_NAME:-security-nexus}-nginx
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # Mount SSL certificates if they exist
      - ./ssl:/etc/nginx/ssl:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      dashboard:
        condition: service_healthy
      monitoring-engine:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3

# ============================================
# Networks
# ============================================
networks:
  nexus-network:
    driver: bridge
    name: ${COMPOSE_PROJECT_NAME:-security-nexus}-network

# ============================================
# Volumes (optional, for future use)
# ============================================
# volumes:
#   postgres_data:
#   redis_data: