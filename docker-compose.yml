# ============================================
# Security Nexus - Docker Compose Configuration
# ============================================
# Make sure to:
# 1. Copy .env.example to .env
# 2. Update .env with your configuration
# 3. Run: docker-compose up -d

services:
  # ============================================
  # TimescaleDB (PostgreSQL + Time-Series)
  # ============================================
  timescaledb:
    image: timescale/timescaledb:latest-pg16
    container_name: ${COMPOSE_PROJECT_NAME:-security-nexus}-timescaledb
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-security_nexus}
      - POSTGRES_USER=${POSTGRES_USER:-nexus}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-nexus_password_changeme}
      - POSTGRES_HOST_AUTH_METHOD=md5
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - timescale-data:/var/lib/postgresql/data
      - ./packages/monitoring-engine/schema.sql:/docker-entrypoint-initdb.d/001-schema.sql:ro
    restart: unless-stopped
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-nexus} -d ${POSTGRES_DB:-security_nexus}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================
  # Monitoring Engine (Rust Backend)
  # ============================================
  monitoring-engine:
    build:
      context: .
      dockerfile: ./packages/monitoring-engine/Dockerfile
      # Use BuildKit for better caching
      cache_from:
        - monitoring-engine:latest
    image: ${COMPOSE_PROJECT_NAME:-security-nexus}/monitoring-engine:latest
    container_name: ${COMPOSE_PROJECT_NAME:-security-nexus}-monitoring-engine
    environment:
      - WS_ENDPOINT=${WS_ENDPOINT:-wss://polkadot.api.onfinality.io/public-ws}
      - CHAIN_NAME=${CHAIN_NAME:-Polkadot}
      - API_PORT=${API_PORT:-8080}
      - RUST_LOG=${RUST_LOG:-monitoring_engine=info}
      - ALLOWED_ORIGIN=${ALLOWED_ORIGIN:-http://localhost:3000}
      # Database connection
      - DATABASE_URL=postgresql://${POSTGRES_USER:-nexus}:${POSTGRES_PASSWORD:-nexus_password_changeme}@timescaledb:5432/${POSTGRES_DB:-security_nexus}
      - DATABASE_MAX_CONNECTIONS=${DATABASE_MAX_CONNECTIONS:-10}
    ports:
      - "${API_PORT:-8080}:8080"
    volumes:
      # Persist chain configuration between restarts
      - chain-config:/app
    depends_on:
      timescaledb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  # ============================================
  # Web Dashboard (Next.js Frontend + SAFT)
  # ============================================
  dashboard:
    build:
      context: .
      dockerfile: ./packages/web-dashboard/Dockerfile
      cache_from:
        - dashboard:latest
    image: ${COMPOSE_PROJECT_NAME:-security-nexus}/dashboard:latest
    container_name: ${COMPOSE_PROJECT_NAME:-security-nexus}-dashboard
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - MONITORING_ENGINE_URL=${MONITORING_ENGINE_URL:-http://monitoring-engine:8080}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:3000}
      - SAFT_BINARY_PATH=/usr/local/bin/saft
    ports:
      - "3000:3000"
    depends_on:
      monitoring-engine:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 60s

  # ============================================
  # Nginx Reverse Proxy
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: ${COMPOSE_PROJECT_NAME:-security-nexus}-nginx
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # Mount SSL certificates if they exist
      - ./ssl:/etc/nginx/ssl:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      dashboard:
        condition: service_healthy
      monitoring-engine:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - nexus-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3

# ============================================
# Networks
# ============================================
networks:
  nexus-network:
    driver: bridge
    name: ${COMPOSE_PROJECT_NAME:-security-nexus}-network

# ============================================
# Volumes
# ============================================
volumes:
  # Persist chain configuration for monitoring engine
  chain-config:
    driver: local

  # TimescaleDB data persistence
  timescale-data:
    driver: local